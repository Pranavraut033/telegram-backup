# GitHub Actions workflow for building Telegram Backup as a standalone executable
# Supports macOS, Windows, and Linux

name: Build Executable

permissions:
  contents: write

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      release_tag:
        description: 'Tag name to release (for example: v1.2.3)'
        required: true
        type: string

jobs:
  build:
    runs-on: ${{ matrix.os }}
    env:
      APPLE_IDENTITY_P12: ${{ secrets.APPLE_IDENTITY_P12 }}
      APPLE_IDENTITY_P12_PASSWORD: ${{ secrets.APPLE_IDENTITY_P12_PASSWORD }}
      APPLE_SIGNING_IDENTITY: ${{ secrets.APPLE_SIGNING_IDENTITY }}
      APPLE_API_KEY_ID: ${{ secrets.APPLE_API_KEY_ID }}
      APPLE_API_ISSUER_ID: ${{ secrets.APPLE_API_ISSUER_ID }}
      APPLE_API_PRIVATE_KEY: ${{ secrets.APPLE_API_PRIVATE_KEY }}
    strategy:
      matrix:
        include:
          - os: ubuntu-latest
            add_data_sep: ':'
          - os: windows-latest
            add_data_sep: ';'
          - os: macos-latest
            add_data_sep: ':'
    steps:
      - uses: actions/checkout@v4
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pyinstaller
      - name: Build executable
        run: |
          pyinstaller --onefile main.py --name telegram-backup --add-data "help.txt${{ matrix.add_data_sep }}."

      - name: "macOS: Code sign"
        if: matrix.os == 'macos-latest' && env.APPLE_IDENTITY_P12 != '' && env.APPLE_IDENTITY_P12_PASSWORD != '' && env.APPLE_SIGNING_IDENTITY != ''
        run: |
          set -euo pipefail
          echo "Preparing keychain and importing identity..."
          echo "$APPLE_IDENTITY_P12" | base64 --decode > apple_identity.p12
          security create-keychain -p "" build_signing.keychain
          security import apple_identity.p12 -k build_signing.keychain -P "$APPLE_IDENTITY_P12_PASSWORD" -T /usr/bin/codesign
          security list-keychains -s build_signing.keychain
          security default-keychain -s build_signing.keychain
          security unlock-keychain -p "" build_signing.keychain
          security set-keychain-settings -t 3600 -u build_signing.keychain

          echo "Signing the binary with: $APPLE_SIGNING_IDENTITY"
          ls -l dist || true
          codesign --timestamp --options runtime --sign "$APPLE_SIGNING_IDENTITY" dist/telegram-backup || true
          spctl -a -vvv dist/telegram-backup || true

      - name: "macOS: Notarize and staple"
        if: matrix.os == 'macos-latest' && env.APPLE_API_KEY_ID != '' && env.APPLE_API_ISSUER_ID != '' && env.APPLE_API_PRIVATE_KEY != ''
        run: |
          set -euo pipefail
          echo "Preparing API key for notarytool..."
          echo "$APPLE_API_PRIVATE_KEY" | base64 --decode > AuthKey_${APPLE_API_KEY_ID}.p8

          echo "Creating package for notarization (zip)..."
          ditto -c -k --sequesterRsrc --keepParent dist/telegram-backup telegram-backup-macos.zip

          echo "Submitting to Apple notarization service..."
          xcrun notarytool submit telegram-backup-macos.zip --key AuthKey_${APPLE_API_KEY_ID}.p8 --key-id "$APPLE_API_KEY_ID" --issuer "$APPLE_API_ISSUER_ID" --wait

          echo "Stapling notarization ticket to binary..."
          xcrun stapler staple dist/telegram-backup
          xcrun stapler validate -v dist/telegram-backup || true

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: telegram-backup-${{ matrix.os }}
          path: dist/telegram-backup*

  release:
    needs: build
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/') || github.event_name == 'workflow_dispatch'
    steps:
      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          path: dist/

      - name: Check build artifacts
        run: |
          count=$(find dist -type f -name 'telegram-backup*' | wc -l)
          if [ "$count" -eq 0 ]; then
            echo "Error: No build artifacts found"
            exit 1
          fi

      - name: Prepare release assets
        run: |
          set -euo pipefail
          mkdir -p release-assets

          while IFS= read -r file; do
            artifact_dir=$(basename "$(dirname "$file")")
            os_name=${artifact_dir#telegram-backup-}
            base=$(basename "$file")

            if [[ "$base" == *.exe ]]; then
              out="release-assets/telegram-backup-${os_name}.exe"
            else
              out="release-assets/telegram-backup-${os_name}"
            fi

            cp "$file" "$out"
            echo "Prepared $out"
          done < <(find dist -type f -name 'telegram-backup*' | sort)

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.release_tag || github.ref_name }}
          files: release-assets/*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
